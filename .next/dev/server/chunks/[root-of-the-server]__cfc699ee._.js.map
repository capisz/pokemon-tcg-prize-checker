{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/admin/Desktop/projects/pokemon-tcg-prize-checker/app/api/cards/route.ts"],"sourcesContent":["// app/api/cards/route.ts\nimport { NextRequest, NextResponse } from \"next/server\"\nimport path from \"path\"\nimport { promises as fs } from \"fs\"\n\nexport const runtime = \"nodejs\"\n\ntype LocalCard = {\n  id?: string\n  name?: string\n  images?: { small?: string; large?: string }\n  imageUrl?: string\n  imageUrlHiRes?: string\n  set?: { id?: string; name?: string }\n  number?: string\n}\n\ntype SetEntry = {\n  id?: string\n  ptcgoCode?: string\n}\n\nconst CARDS_BASE_PATH = path.join(\n  process.cwd(),\n  \"TCGData\",\n  \"pokemon-tcg-data-master\",\n  \"cards\",\n  \"en\"\n)\n\nconst SETS_FILE_PATH = path.join(\n  process.cwd(),\n  \"TCGData\",\n  \"pokemon-tcg-data-master\",\n  \"sets\",\n  \"en.json\"\n)\n\n// Caches so we don't re-read from disk every request\nlet allCardsCache: LocalCard[] | null = null\nlet setCodeMapCache: Record<string, string> | null = null\n\nasync function loadSetCodeMap(): Promise<Record<string, string>> {\n  if (setCodeMapCache) return setCodeMapCache\n\n  try {\n    const raw = await fs.readFile(SETS_FILE_PATH, \"utf8\")\n    const sets: SetEntry[] = JSON.parse(raw)\n\n    const map: Record<string, string> = {}\n\n    for (const set of sets) {\n      const id = set.id\n      const code = set.ptcgoCode\n      if (!id || !code) continue\n      // ptcgoCode (what Live exports use) -> internal set id\n      map[code.toLowerCase()] = id.toLowerCase()\n    }\n\n    setCodeMapCache = map\n    console.log(\n      `Loaded ${Object.keys(map).length} set code mappings from sets/en.json`\n    )\n    return map\n  } catch (err) {\n    console.error(\"Failed to load set code map from sets/en.json:\", err)\n    // Fallback: empty map, so we just use the raw set code\n    setCodeMapCache = {}\n    return setCodeMapCache\n  }\n}\n\nasync function loadAllCards(): Promise<LocalCard[]> {\n  if (allCardsCache) return allCardsCache\n\n  const files = (await fs.readdir(CARDS_BASE_PATH)).filter((f) =>\n    f.endsWith(\".json\")\n  )\n  const result: LocalCard[] = []\n\n  for (const file of files) {\n    const filePath = path.join(CARDS_BASE_PATH, file)\n    try {\n      const raw = await fs.readFile(filePath, \"utf8\")\n      const json = JSON.parse(raw)\n      const cards: LocalCard[] = Array.isArray(json) ? json : json.data ?? []\n      result.push(...cards)\n    } catch (err) {\n      console.error(`Failed to read card file ${filePath}:`, err)\n    }\n  }\n\n  allCardsCache = result\n  console.log(`Loaded ${result.length} cards from local data (${files.length} files)`)\n  return result\n}\n\nfunction buildId(setId: string, number: string) {\n  return `${setId.toLowerCase()}-${number.toLowerCase()}`\n}\n\nasync function mapLiveSetCodeToInternalId(liveSetCode: string) {\n  const map = await loadSetCodeMap()\n  const lc = liveSetCode.toLowerCase()\n\n  // --- manual aliases for codes that aren't in sets/en.json yet ---\n  if (lc === \"mee\") {\n    // \"Mega Energies\" -> reuse Scarlet & Violet Energies images\n    return \"sve\"\n  }\n  // ----------------------------------------------------------------\n\n  // If we know this ptcgoCode (PFL, PAF, TEF, etc.), return the dataset id (me2, sv4pt5, sv5, ...)\n  return map[lc] ?? lc\n}\n\nasync function getCardFromLocalId(rawId: string) {\n  const [liveSetCode, cardNumber] = rawId.split(\"-\")\n  if (!liveSetCode || !cardNumber) return null\n\n  const canonicalSetId = await mapLiveSetCodeToInternalId(liveSetCode)\n\n  const candidateIds = [\n    buildId(canonicalSetId, cardNumber), // e.g. me2-7 for PFL-7\n    buildId(liveSetCode, cardNumber),    // e.g. pfl-7 just in case\n  ]\n\n  const cards = await loadAllCards()\n\n  // Try match by card.id\n  let match =\n    cards.find(\n      (c) => c.id && candidateIds.includes(c.id.toLowerCase())\n    ) ??\n    // Then by set.id + number\n    cards.find((c) => {\n      const setId = c.set?.id\n      const num = c.number\n      if (!setId || !num) return false\n      const cid = buildId(setId, num)\n      return candidateIds.includes(cid)\n    })\n\n  if (!match) {\n    console.warn(`No local card found for ${rawId}`)\n    return null\n  }\n\n  const image =\n    match.images?.small ??\n    (match as any).imageUrl ??\n    (match as any).imageUrlHiRes ??\n    undefined\n\n  const setName = match.set?.name ?? liveSetCode.toUpperCase()\n\n  return {\n    id: rawId,\n    name: match.name ?? `${liveSetCode.toUpperCase()} ${cardNumber}`,\n    image,\n    set: setName,\n    number: match.number ?? cardNumber,\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json()\n    const ids: string[] = Array.isArray(body.ids) ? body.ids : []\n\n    if (!ids.length) {\n      return NextResponse.json({ cards: [] }, { status: 200 })\n    }\n\n    const cards = await Promise.all(\n      ids.map(async (rawId) => {\n        const card = await getCardFromLocalId(rawId)\n\n        if (card) return card\n\n        // Fallback: text-only placeholder if we can't find an image\n        const [setCode, num] = rawId.split(\"-\")\n        return {\n          id: rawId,\n          name: `Card ${rawId.toUpperCase()}`,\n          image: undefined,\n          set: setCode?.toUpperCase() ?? \"Unknown Set\",\n          number: num ?? \"??\",\n        }\n      })\n    )\n\n    return NextResponse.json({ cards }, { status: 200 })\n  } catch (err) {\n    console.error(\"Error in /api/cards:\", err)\n    return NextResponse.json(\n      { error: \"Failed to load cards\" },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}